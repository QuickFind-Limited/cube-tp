cubes:
  - name: order_discount_applications
    sql_table: "`magical-desktop.shopify.order_discount_applications_with_pst`"

    description: Discount code usage and promotion effectiveness

    joins:
      - name: orders
        sql: "{CUBE}.order_id = {orders}.order_id"
        relationship: many_to_one

    dimensions:
      - name: line_item_id
        sql: line_item_id
        type: string
        primary_key: true

      - name: order_id
        sql: order_id
        type: string

      - name: product_id
        sql: product_id
        type: string

      - name: product_title
        sql: product_title
        type: string

      - name: sku
        sql: sku
        type: string

      - name: quantity
        sql: quantity
        type: number

    measures:
      # DM001: Total Discount Amount
      - name: total_discount_amount
        type: sum
        sql: total_discount_amount
        description: "DM001 - Total discount value"

      # Unit level discount
      - name: unit_discount_total
        type: sum
        sql: unit_discount_amount
        description: "Total unit-level discounts"

      # Line item count
      - name: line_count
        type: count
        sql: line_item_id
        description: "Count of discounted line items"

      # Orders with discounts
      - name: discounted_order_count
        type: count_distinct_approx
        sql: order_id
        description: "Count of orders with discounts applied (HyperLogLog ~2% accuracy)"

      # Average discount percentage
      - name: avg_discount_percentage
        type: avg
        sql: discount_percentage
        description: "Average discount percentage"

    pre_aggregations:
      # Pre-agg 8: Discount analysis
      - name: discounts_by_product
        type: rollup
        dimensions:
          - product_title
        measures:
          - total_discount_amount
          - unit_discount_total
          - line_count
          - discounted_order_count
          - avg_discount_percentage
        refresh_key:
          every: 365 days
